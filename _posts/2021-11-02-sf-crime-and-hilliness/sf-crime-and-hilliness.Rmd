---
title: "Crime and Topography in San Francisco"
description: |
  Does topography have an effect on the likelihood of car break-ins? This regression analysis seeks to provide insights into this question using data from San Francisco, which has the ideal geography for this context.
author:
  - name: Alex Clippinger
    url: {}
date: 2021-11-02
output:
  distill::distill_article:
    self_contained: false
    code_folding: true
    toc: true              
    toc_float: true
bibliography: bibliography.bib
preview: images/crime_hills.jpg
categories: 
  - R
  - GIS
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE, 
                      include = TRUE)

options(scipen=999)

library(sf)
library(tidyverse)
library(tidycensus)
library(patchwork)
library(lubridate)
library(modelr)
library(kableExtra)
library(xtable)
library(jtools)
library(psych)
```

```{r load data, include = FALSE}
crimes <- st_read("data/crime_reports_2018_present/motor_vehicle_theft/motor_vehicle_theft_w_slope.shp", query = "SELECT date_incid, slope FROM motor_vehicle_theft_w_slope WHERE slope IS NOT NULL")

contours <- st_read("data/contours/contours.shp") %>% 
  st_transform(crs = st_crs(7132))

# To access ACS data through tidycensus, first an API key needs to be registered.
census_geom <- get_acs(geography = 'tract',
                       variables = "B19013_001",
                       state = "CA",
                       county = "San Francisco",
                       geometry = TRUE) %>% 
  st_transform(crs = st_crs(7132))
```

<figure>

<img src="./images/san-francisco-hills.jpg" alt="A particularly steep San Francisco street" style="height: 534px; width:800px;"/>

<figcaption>

That is one steep street!

</figcaption>

</figure>

## Analysis Plan

This analysis will follow the specific steps outlined in Table 1 below:

```{r}
data.frame("Step" = c(1:9),
           "Description" = c("Identify research question", 
                             "Select key variables (based on existing literature)",
                             "Collect data",
                             "Merge data",
                             "Data description",
                             "Visualize relationships",
                             "Test OLS assumptions",
                             "Conduct regression analysis",
                             "Interpret results")) %>% 
  kable(caption = "Analysis Plan") %>%
  kable_paper(full_width = FALSE) %>%
  kable_styling(latex_options = "striped",
                font_size = 15) %>% 
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T, color = "black")
```

## 1. Research Question

My research question is: **What is the relationship between topography and car break-ins in San Francisco?**

### Background

Both terrain and motor vehicle crimes are ubiquitous when discussing living or visiting San Francisco. This relationship has been coined by the phrase - ["Crime Doesn't Climb"](https://github.com/gwintrob/crime-doesnt-climb). In April 2021, Young-An Kim & James C. Wo published [Topography and crime in place: The effects of elevation, slope, and betweenness in San Francisco street segments](https://www.tandfonline.com/doi/full/10.1080/07352166.2021.1901591). This study supports the idea that "hilliness" has an effect on crime, taking into consideration socio-economic characteristics @sfcrime. However, their analysis did not separate by specific crime categories and instead included all types of crime, including violent, nonviolent, property, etc.  **My analysis will focus only on car break-ins rather than all crime reports**, as I believe that these crimes will have a more significant relationship with topography. In addition, my analysis will use more recent crime report and socio-economic data sets.

Understanding the relationship between topography and car break-ins can influence local-level policy decisions and direct limited resources dedicated to crime prevention. For example, the city could focus enforcement and policy on areas within certain elevation and slope ranges that are identified in this analysis as being particularly susceptible to car break-ins.

## 2. Select key variables

Table 2 below contains the key measures of interest in our analysis:

```{r}
data.frame("Dependent Variable" = c("Crime (specifically car break-ins)", ""),
           "Independent Variables" = c("Elevation", "Slope"), 
           "Control Variable" = c("Median Income","")) %>% 
  kable(col.names = c("Dependent Variable", "Independent Variables", "Control Variable"), caption = "Key variables for regression analysis") %>%
  kable_paper(full_width = FALSE) %>%
  kable_styling(latex_options = "striped",
                font_size = 15) %>% 
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T, color = "black")

```

When discussing topography, both elevation and "hilliness", or slope, are necessary for inclusion. This is because it more accurately captures the effect of local level topography, which is supported by Kim & Wo. 

In any econometric analysis, it is vital to control for socio-economic variables. In this case, it could be that higher elevations in the city are more affluent areas, which may have an impact on crime. Thus, we want to include median income as a control variable. 

Here is the regression equation:

$$MotorVehicleTheft_i = \beta_0 + \beta_1Elevation_i + \beta_2Slope_i + \beta_3MedianIncome_i + u_i$$

## 3. Collect data

- **Crime** (@sfdata)
  - Retrieved from the [San Francisco Open Data Portal](https://data.sfgov.org/Public-Safety/Police-Department-Incident-Reports-2018-to-Present/wg3w-h783)
  - All crime reports from 2018-01-01 to 2021-11-04.
    - Queried to only include "Motor Vehicle Theft"
  - Locations are aggregated to closest street intersections.

- **Elevation contours** (@sfdata)
  - Retrieved from the [San Francisco Open Data Portal](https://data.sfgov.org/Energy-and-Environment/Elevation-Contours/rnbg-2qxw)
  - 5 ft. elevation contours
  - Used directly for **elevation** and also to derive **slope** through a geo-processing workflow in QGIS with GRASS (see [this video](https://www.youtube.com/watch?v=MvnW6w1_yJg) for details on this process).

- **Median income** (@tidycensus)
  - Retrieved through the `tidycensus` package via the [US Census Bureau](https://www.census.gov/data/developers/data-sets.html).
  - census Tract detail level from the 5-year 2015-2019 ACS data.

## 4. Merge Data

Since our variables interact over space, we merge the crimes, topography, and median income data sets by spatially joining them together. All data sets are loaded into `R` as **shapefiles** in the Coordinate Reference System (CRS) EPSG:7132 (NAD83(2011) / San Francisco CS13 (ftUS)), which is a projected CRS for the city and county of San Francisco, adequate for high-precision (0.03 ft) analysis.

```{r merge data}
# Find index of nearest contour to each crime
elev <- st_nearest_feature(x = crimes, y = contours)

# Add elevation and binary slope columns
crimes <- crimes %>% 
  st_join(y = census_geom, join = st_within, left = TRUE) %>% 
  mutate(elev = contours[elev,]$elevation) %>% 
  rename(median_income = estimate) %>% 
  select(date_incid, slope, median_income, elev, geometry)
```

## 5. Data description

The summary statistics for the data are provided in Table 3 below.

```{r}
crimes %>% 
  st_drop_geometry() %>% 
  select(slope, elev, median_income) %>% 
  psych::describe(fast=TRUE) %>% 
  kable(col.names = c("", "Count", "Mean", "SD", "Min", "Max", "Range", "SE"), caption = "Summary statistics for Slope, Elevation, and Median Income variables") %>%
  kable_paper(full_width = FALSE) %>%
  kable_styling(latex_options = "striped",
                font_size = 15) %>% 
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T, color = "black")
```

We can see in the **Count** column that there are 24,454 total break-ins in our data, with some missing values for median income. The **slope** ranges from 0 to 68 percent (~34 degrees) with a mean value of approximately 4.5 percent. This indicates that there are vastly more break-ins on flatter streets as expected. The **elevation** ranges from -5 to 780 feet with a mean value of approximately 130 (note: negative values are a result of attaching the nearest contour level to crimes very close to the coastline). Again, there are more break-ins at lower elevations than higher. The **median income** ranges from ~$12,000 to ~$208,000 with a mean value of approximately $114,000. This indicates that our median income data appears to be somewhat evenly distributed.

The box plots below visualize these observations:

```{r}
slope_box <- ggplot(data = crimes, aes(x = "", y = slope)) +
  geom_boxplot() +
  geom_jitter(aes(color = slope), 
              width = 0.2,
              size=0.4, 
              alpha=0.025, 
              show.legend = FALSE) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Slope (percent)")

elev_box <- ggplot(data = crimes, aes(x = "", y = elev)) +
  geom_boxplot() +
  geom_jitter(aes(color = elev), 
              width = 0.2,
              size=0.4, 
              alpha=0.025, 
              show.legend = FALSE) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Elevation (feet)")

income_box <- ggplot(data = crimes, aes(x = "", y = median_income)) +
  geom_boxplot() +
  geom_jitter(aes(color = median_income), 
              width = 0.2,
              size=0.4, 
              alpha=0.025, 
              show.legend = FALSE) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Median Income (USD)")

elev_box + slope_box + income_box + plot_annotation(title = 'Boxplots of Independent Variables',
                                                    theme = theme(plot.title = element_text(hjust = 0.5)))
```

The box plots more clearly demonstrate that both elevation and slope have more occurrences at low values than high values, with extremely high outliers. These outliers are mostly trustworthy - the highest peak in San Francisco is Mount Davidson at 938 feet and the steepest surveyed road is Bradford Street at 41% grade. This indicates that at least two of our slope outliers are due to data artifacts.

## 6. Visualize relationships

The following plots show the simple relationships between count of car break ins and the three independent variables (elevation, slope, and median income). 

```{r}
# Group by income
income_summary <- crimes %>% 
  st_drop_geometry() %>% 
  group_by(median_income) %>% 
  summarize(count = n())

income_plot = ggplot(data = income_summary, aes(x = median_income, y = count)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(title = "Crime and Median Income",
       x = "Median Income (USD)",
       y = "Number of Break-Ins")

# Group by elevation
elev_summary <- crimes %>% 
  st_drop_geometry() %>% 
  group_by(elev) %>% 
  summarize(count = n())

elev_plot <- ggplot(data = elev_summary, aes(x = elev, y = count)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(title = "Crime and Elevation",
       x = "Elevation (feet)",
       y = "Number of Break-Ins")

# Group by slope
slope_summary <- crimes %>% 
  st_drop_geometry() %>% 
  group_by(slope) %>% 
  summarize(count = n())

slope_plot <- ggplot(data = slope_summary, aes(x = slope, y = count)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(title = "Crime and Slope",
       x = "Slope (percent)",
       y = "Number of Break-Ins")

elev_plot + (slope_plot / income_plot)
```

We see there is a negative correlation between elevation and crime. It is possible that this relationship is not linear, so this variable may fit better if we take the natural log. Since slope in this analysis is a binary variable, we simply see that there are more crimes in areas that are not designated high slope. Lastly, we observe a weak negative correlation between median income and car break-ins.

The following plots show crimes over the time period of our data. 

```{r}
# Group by all three variables
crimes_summary <- crimes %>% 
  st_drop_geometry() %>% 
  group_by(slope, median_income, elev) %>% 
  summarize(count = n())

# Group by date
crimes_ts <- crimes %>% 
  st_drop_geometry() %>% 
  group_by(date_incid) %>% 
  summarize(count = n())

ts_plot <- ggplot(data = crimes_ts, aes(x = date_incid, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(title = "Daily Crime 2018-Present",
       x = "Date (daily)",
       y = "Number of Break-Ins")

crimes_monthly <- crimes_ts %>% 
  mutate(month = lubridate::floor_date(date_incid, "month")) %>% 
  group_by(month) %>% 
  summarize(monthly_sum = sum(count)) %>% 
  filter(month != "2021-11-01")

monthly_plot <- ggplot(data = crimes_monthly, aes(x = month, y = monthly_sum)) +
  geom_point() +
  geom_line() + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(title = "Monthly Crime 2018-Present",
       x = "Date (monthly)",
       y = "Number of Break-Ins")

ts_plot + monthly_plot
```

We can see that there is an upward trend to our crime data over the time period of our data.

```{r}
#bbox <- st_bbox(census_geom)

library(tmap)
tmap_mode("view")

tm_shape(crimes)+
  tm_dots("elev")
```

### 7. Test OLS Assumptions

Recall our four key assumptions for OLS:

1. The population relationship is linear in parameters with an additive disturbance.

2. Our $X$ variables are **exogenous**, _i.e._, $\mathop{\boldsymbol{E}}\left[ u \mid X \right] = 0$.

3. The $X$ variables have variation. 

4. The population disturbances $u_i$ are independently and identically distributed as **normal** random variables with mean zero $\left( \mathop{\boldsymbol{E}}\left[ u \right] = 0 \right)$ and variance $\sigma^2$ (_i.e._,  $\mathop{\boldsymbol{E}}\left[ u^2 \right] = \sigma^2$)

We assume that assumptions 1 and 2 hold. Assumption 3 holds because we see that the $x$ variables have variation in the plots above. Below, the residuals are generated from the main regression and are used to assess the three components of assumption #4.

```{r}
crime_lm <- crimes_summary %>% 
  add_predictions(model = lm(count ~ elev + slope + median_income, data = crimes_summary)) %>% 
  mutate(res = count - pred)

ggplot(data = crime_lm, aes(x = res)) +
  geom_histogram(binwidth = 5, fill = "darkblue", col = "black") + 
  labs(title = "Residual Plot",
       x = "Residuals",
       y = "Count") +
  theme_classic()
```

The residuals do not appear to be normally distributed. There is a long right tail with high outliers. This indicates that the regression analysis is systematically under-predicting counts of car break-ins.

```{r}
ggplot(data = crime_lm, aes(sample = res)) +
  geom_qq() +
  geom_qq_line() +
  theme_classic() +
  labs(title = "QQ Plot",
       x = "Theoretical Normal Distribution",
       y = "Analysis Distribution")
```

The qq plot shows that the distribution is mostly normally distributed for values up to approximately 2. This suggests that the model is not normally distributed for extreme high values.

```{r}
x <- ggplot(data = crime_lm, aes(x = count, y = res)) +
  geom_point() + theme_classic() +
  labs(title = "Residuals vs Dependent (Break-Ins)",
       x = "Number of Break-Ins",
       y = "Residual Error")

y1 <- ggplot(data = crime_lm, aes(x = elev, y = res)) +
  geom_point() + theme_classic() + 
  labs(title = "Residuals vs. Elevation",
       x = "Elevation (feet)",
       y = "Residual Error")

y2 <- ggplot(data = crime_lm, aes(x = slope, y = res)) +
  geom_point() + theme_classic() + 
  labs(title = "Residuals vs. Slope",
       x = "Slope (percent)",
       y = "Residual Error")

y3 <- ggplot(data = crime_lm, aes(x = median_income, y = res)) +
  geom_point() + theme_classic() + 
  labs(title = "Residuals vs. Income",
       x = "Median Income",
       y = "Residual Error")

(x + y1) / (y2 + y3)
```

Since assumptions 1, 2, and 3 appear to be satisfied, using OLS in this case is an unbiased estimator. However, residual plots indicate that assumption 4 may not be satisfied and therefore OLS may not be the estimator with lowest variance. Thus, an alternative estimator to OLS may provide estimates of the true population parameters with less variance.

## 8. Regression Analysis

### Model 1

$$MotorVehicleTheft_i = \beta_0 + \beta_1Elevation_i + \beta_2Slope_i + \beta_3MedianIncome_i + u_i$$

```{r}
model <- lm(formula = count ~ elev + slope + median_income, data = crimes_summary)

summ(model, digits = 7) 
```

### Model 2: Remove median income variable

$$MotorVehicleTheft_i = \beta_0 + \beta_1Elevation_i + \beta_2Slope_i + u_i$$

```{r}
model <- lm(formula = count ~ elev + slope, data = crimes_summary)

summ(model, digits = 7) 
```

### Model 3: Logarithmic transformation

$$log(MotorVehicleTheft_i) = \beta_0 + \beta_1Elevation_i + \beta_2Slope_i + \beta_3MedianIncome_i + u_i$$

```{r}
model_transformed <- lm(formula = log(count) ~ elev + slope + median_income, data = crimes_summary)

summ(model_transformed, digits = 7)
```

## 9. Results

- Interpret the simple visualizations
- Interpret the R^2 of the two models
- Interpret the OLS assumptions
- Conclusions: What are our predicted effects of independent variables on dependent
- Conclusions: What are the studies flaws? Biases? 
- Conclusions: What are possibilities for improvement
- Finish in project interpretation
- Review rubric

  






